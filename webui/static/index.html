<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>mitoSpotter Control Center</title>
      <link rel="icon" type="image/png" href="/static/logo.png" />
      <link rel="shortcut icon" type="image/png" href="/static/logo.png" />
      <link rel="stylesheet" href="/static/styles.css" />
    </head>
  <body>
    <header class="app-header">
      <div class="header-inner">
        <div class="brand">
          <h1><em>mitoSpotter</em></h1>
          <p>A HMM-based tool to classify nuclear genes and mitochondria genes in an annotation-independent manner.</p>
        </div>
        <img src="/static/logo.png" alt="mitoSpotter logo" class="site-logo" />
      </div>
    </header>

    <main class="app-main">
      <section class="card">
        <div class="card-header">
          <h2>Decode</h2>
          <button id="help-btn" class="help-btn" type="button">See instructions</button>
        </div>
        <form id="decode-form" class="form-grid">
          <div class="form-group">
            <label>Decoder Type</label>
            <div role="group" aria-label="Decoder Type" class="radio-row">
              <label class="radio"><input type="radio" name="mode" value="nt1" id="mode_nt1" checked /> Single nucleotide (1-nt)</label>
              <label class="radio"><input type="radio" name="mode" value="nt2" id="mode_nt2" /> Di-nucleotide (2-nt)</label>
              <label class="radio"><input type="radio" name="mode" value="nt3" id="mode_nt3" /> Tri-nucleotide (3-nt)</label>
            </div>
          </div>

          <div class="form-group span-2">
            <div class="label-row">
              <label for="sequence_text">Nucleotide Sequences</label>
              <button type="button" id="load-demo" class="demo-button">Load demo sequence</button>
            </div>
            <textarea
              id="sequence_text"
              name="sequence_text"
              rows="8"
              placeholder=">seq1\nATG...\n>seq2\n... or enter raw sequences per line"
            ></textarea>
            <small>Paste FASTA-formatted or plain sequences (optional).</small>
          </div>

          <div class="form-group">
            <div class="label-row">
              <label for="fasta_file">Upload FASTA</label>
              <div class="inline-actions">
                <span id="fasta-loaded-badge" class="badge-check" hidden title="FASTA loaded" aria-live="polite">✓</span>
                <button type="button" id="load-demo-fasta" class="demo-button">Load demo FASTA</button>
              </div>
            </div>
            <input type="file" id="fasta_file" name="fasta_file" accept=".fa,.fasta,.fna,.txt" />
            <small>Provide a single FASTA file. You may also paste sequences above.</small>
          </div>

          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" id="emit_path" name="emit_path" />
              <span>Include Viterbi state path</span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" id="plotting" name="plotting" />
              <span>Generate and show plots</span>
            </label>
          </div>

          <div class="form-actions span-2">
            <button type="submit" class="primary">Run Decode</button>
            <button type="reset" class="secondary">Clear</button>
          </div>
        </form>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </section>

      <section class="card" id="results-card" hidden>
        <div class="card-header">
          <h2>Results</h2>
          <div class="download-wrapper">
            <button id="download-results" class="download-btn" type="button" hidden>Download Results</button>
            <div id="download-menu" class="download-menu" hidden>
              <button type="button" data-format="tsv">Download TSV</button>
              <button type="button" data-format="csv">Download CSV</button>
            </div>
          </div>
        </div>
        <p id="results-summary" class="results-summary" hidden></p>

        <div class="plots-section" id="plots-section" hidden>
          <h3>Plots</h3>
          <div class="plots-grid" id="plots-grid"></div>
        </div>

          <div class="table-wrapper">
            <table id="results-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Call</th>
                  <th>Nuclear%</th>
                  <th>Mito%</th>
                  <th id="len-header">Nucleotides</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        <div id="paths" class="paths"></div>
      </section>
    </main>

    <footer class="app-footer">
      <a href="https://github.com/EthanShenx" target="_blank" rel="noopener noreferrer">Developed by Ethan Shen</a>
    </footer>

    <!-- Lightbox modal for zooming and downloading plots -->
    <div class="lightbox" id="lightbox" aria-hidden="true" role="dialog" aria-label="Plot viewer">
      <div class="lightbox-inner">
        <img id="lightbox-img" class="lightbox-img" alt="plot" />
        <div class="lightbox-toolbar">
          <span id="lightbox-caption"></span>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <button class="icon-btn" id="lightbox-close" type="button">Close</button>
            <button class="icon-btn primary" id="lightbox-download" type="button">Download</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions modal -->
    <div class="modal" id="help-modal" aria-hidden="true" role="dialog" aria-label="Instructions">
      <div class="modal-inner" role="document">
        <div class="modal-header">
          <h3>How to Use mitoSpotter</h3>
          <button class="icon-btn" id="help-close" type="button" aria-label="Close">Close</button>
        </div>
        <div class="modal-content">
          <h4>Inputs</h4>
          <ul>
            <li>Paste nucleotide sequences in FASTA or plain text.</li>
            <li>Or upload a single FASTA file. Do not mix both demo FASTA and demo sequence at once.</li>
            <li>Select decoder type: 1‑nt, 2‑nt, or 3‑nt (codon‑stride).</li>
          </ul>

          <h4>Options</h4>
          <ul>
            <li>Include Viterbi state path: emits per‑sequence state path (N/M) for visualization.</li>
            <li>Generate and show plots: produces GC/AT and state proportion charts for quick inspection.</li>
          </ul>

          <h4>Running</h4>
          <ul>
            <li>Click “Run Decode”. The backend runs the HMM decoder for the chosen n‑gram.</li>
            <li>Status messages appear above; errors are reported clearly.</li>
          </ul>

          <h4>Interpreting Results</h4>
          <ul>
            <li>Summary: brief sentence indicating the predicted class for the first record.</li>
            <li>Plots: thumbnails of generated charts. Click to zoom and download if needed.</li>
            <li>Table:
              <br/>ID = sequence id;
              Call = predicted class;
              Nuclear% / Mito% = fraction of Viterbi path in each state;
              Length = nucleotide or token length per mode.</li>
            <li>Paths: compact bar showing N/M runs along the Viterbi path (if enabled).</li>
          </ul>

          <h4>Export</h4>
          <ul>
            <li>Download TSV/CSV of the results from the Results card’s menu.</li>
          </ul>

          <h4>Troubleshooting</h4>
          <ul>
            <li>If no results, ensure sequences meet length thresholds and match the selected mode.</li>
            <li>If demo FASTA is loaded, loading demo sequence will clear FASTA (and vice versa).</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="/static/app.js" type="module"></script>
  </body>
</html>
